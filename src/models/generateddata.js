const { LocalizationConfig } = require('./localizationconfig');
const { PageConfig } = require('./pageconfig');
const { PageTemplate } = require('./pagetemplate');
const { PageSet } = require('./pageset');
const { PageSetCreator } = require('../commands/build/pagesetcreator');
const { ConfigLocalizer } = require('../commands/build/configlocalizer');
const { TemplateLocalizer } = require('../commands/build/templatelocalizer');

/**
 * Data model for the data generated by Jambo, aggregated from configs and PageTemplates.
 */
exports.GeneratedData = class {
  constructor({ globalConfig, localizationConfig, pageConfigs, pageTemplates }) {
    /**
     * @type {Object}
     */
    this.globalConfig = globalConfig || {};

    /**
     * @type {LocalizationConfig}
     */
    this.localizationConfig = localizationConfig;

    /**
     * @type {String}
     */
    this.defaultLocale = localizationConfig.getDefaultLocale() || globalConfig.locale || '';

    /**
     * @type {Array<PageConfig>}
     */
    this.localizedPageConfigs = new ConfigLocalizer({
      localizationConfig: localizationConfig,
      defaultLocale: this.defaultLocale
    }).createLocalizedPageConfigs(pageConfigs);

    /**
     * @type {Array<PageTemplates>}
     */
    this.localizedPageTemplates = new TemplateLocalizer({
      localizationConfig: localizationConfig,
      defaultLocale: this.defaultLocale
    }).createLocalizedPageTemplates(pageTemplates);
  }

  /**
   * Returns the localized global config
   *
   * @param {String} locale
   * @returns {Object}
   */
  getGlobalConfig (locale) {
    return Object.assign({},
      this.globalConfig,
      {
        experienceKey: this.localizationConfig.getExperienceKey(locale) || this.globalConfig.experienceKey,
        apiKey: this.localizationConfig.getApiKey(locale) || this.globalConfig.apiKey,
        locale: locale || this.globalConfig.locale
      }
    );
  }

  /**
   * Gets the locales configured through Jambo
   *
   * @param {String} locale
   * @returns {Array<String>}
   */
  getLocales () {
    const locales = this.localizationConfig.getLocales();
    return locales.length ? locales : [ this.defaultLocale ];
  }

  /**
   * Gets the page config set for a given locale
   *
   * @param {String} locale
   * @returns {Array<PageConfig>}
   */
  getPageConfigs (locale) {
    return this.localizedPageConfigs.filter(config => config.getLocale() === locale);
  }

  /**
   * Gets the page template set for a given locale
   *
   * @param {String} locale
   * @returns {Array<PageTemplate>}
   */
  getPageTemplates (locale) {
    return this.localizedPageTemplates.filter(template => template.getLocale() === locale);
  }

  /**
   * Builds the PageSet for the given locale
   *
   * @param {String} locale
   * @returns {PageSet}
   */
  buildPageSet (locale) {
    return PageSetCreator({
      locale: locale,
      params: this.localizationConfig.getParams(locale),
      globalConfig: this.getGlobalConfig(locale),
    }).create({
      pageConfigs: this.getPageConfigs(locale),
      pageTemplates: this.getPageTemplates(locale),
      urlFormatter: this.localizationConfig.getUrlFormatter(locale),
    });
  }
}
